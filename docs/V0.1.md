# Flask è‡ªåŠ¨å›¾ç‰‡åº“ï¼ˆæŒ‰æ–‡ä»¶å¤¹åˆ†ç±» + æ—¥æœŸ + æ ‡é¢˜ï¼‰

> åŠŸèƒ½ï¼šè‡ªåŠ¨æ‰«æ `images/åˆ†ç±»/ç›¸å†Œ/å›¾ç‰‡` ç›®å½•ç»“æ„ï¼Œç”Ÿæˆæ¼‚äº®çš„å›¾ç‰‡ç½‘ç«™ï¼›â€œåˆ†ç±»â€ä¸â€œç›¸å†Œæ ‡é¢˜/æ—¶é—´â€ä»æ–‡ä»¶å¤¹åè‡ªåŠ¨è§£æã€‚
>
> ç¤ºä¾‹ï¼š`images/åŒ—äº¬/å¤©å®‰é—¨ 2025 å¹´ 8 æœˆ 24 æ—¥/*.jpg`

---

## ä¸€ã€é¡¹ç›®ç»“æ„ï¼ˆå¤åˆ¶å³å¯ï¼‰

```
flask-gallery/
  app.py
  templates/
    base.html
    index.html
    category.html
    album.html
  static/
    style.css
  images/              # ä½ è‡ªå·±çš„å›¾ç‰‡æ ¹ç›®å½•ï¼ˆå¯æ”¾ä¸­æ–‡åï¼‰
    åŒ—äº¬/
      å¤©å®‰é—¨ 2025 å¹´ 8 æœˆ 24 æ—¥/
        001.jpg
        002.png
    å¤©æ´¥/
      å—é—¨æ¶®è‚‰2025 å¹´ 8 æœˆ 25 æ—¥/
        a.jpg
```

---

## äºŒã€ä½¿ç”¨æ–¹å¼

1. å°†æœ¬é¡µæ‰€æœ‰æ–‡ä»¶æŒ‰ç»“æ„æ”¾åˆ°ä½ çš„é¡¹ç›®ç›®å½•ï¼ˆ`flask-gallery/`ï¼‰ã€‚
2. å®‰è£…ä¾èµ–ï¼š`pip install flask`
3. è¿è¡Œï¼š`python app.py`ï¼Œè®¿é—® `http://127.0.0.1:5000/`

> æ”¯æŒçš„å›¾ç‰‡åç¼€ï¼š`jpg, jpeg, png, webp, gif, bmp`

---

## ä¸‰ã€app.pyï¼ˆæ ¸å¿ƒé€»è¾‘ï¼šæ‰«æç›®å½•ã€è§£ææ ‡é¢˜ä¸æ—¥æœŸã€URL è·¯ç”±ï¼‰

```python
# app.py
from __future__ import annotations
from dataclasses import dataclass
from pathlib import Path
from typing import List, Optional, Tuple
import datetime as dt
import re
import time

from flask import Flask, render_template, send_from_directory, abort, url_for
from werkzeug.utils import safe_join

# ====== åŸºæœ¬é…ç½® ======
BASE_DIR = Path(__file__).resolve().parent
IMAGES_ROOT = BASE_DIR / "images"  # ä½ çš„å›¾ç‰‡æ ¹ç›®å½•
ALLOWED_EXTS = {".jpg", ".jpeg", ".png", ".webp", ".gif", ".bmp"}
CACHE_TTL_SECONDS = 5  # æ‰«æç¼“å­˜çš„ç”Ÿå­˜æœŸï¼ˆç§’ï¼‰

app = Flask(__name__)


# ====== æ•°æ®ç»“æ„ ======
@dataclass
class Album:
    category: str            # åˆ†ç±»æ–‡ä»¶å¤¹åï¼ˆä¸­æ–‡å¯ï¼‰
    folder: str              # ç›¸å†Œæ–‡ä»¶å¤¹åï¼ˆåŸå§‹ï¼‰
    title: str               # ä» folder è§£æçš„â€œæ ‡é¢˜â€
    date: Optional[dt.date]  # ä» folder è§£æçš„â€œæ—¥æœŸâ€ï¼ˆå¯ç©ºï¼‰
    rel_dir: str             # ç›¸å†Œç›¸å¯¹ images çš„è·¯å¾„ï¼ˆç”¨äºæ‹¼ URLï¼‰
    images: List[str]        # ç›¸å†Œå†…å›¾ç‰‡æ–‡ä»¶ååˆ—è¡¨ï¼ˆä¸å«è·¯å¾„ï¼‰

    @property
    def cover_relfile(self) -> Optional[str]:
        return f"{self.rel_dir}/{self.images[0]}" if self.images else None


@dataclass
class Category:
    name: str                 # åˆ†ç±»æ–‡ä»¶å¤¹å
    rel_dir: str              # ç›¸å¯¹ images çš„è·¯å¾„ï¼ˆå°±æ˜¯ nameï¼‰
    albums: List[Album]

    @property
    def total_albums(self) -> int:
        return len(self.albums)

    @property
    def total_images(self) -> int:
        return sum(len(a.images) for a in self.albums)

    @property
    def cover_relfile(self) -> Optional[str]:
        # é€‰ç¬¬ä¸€ä¸ªæœ‰å°é¢çš„ç›¸å†Œ
        for a in self.albums:
            if a.cover_relfile:
                return a.cover_relfile
        return None


# ====== å·¥å…·å‡½æ•° ======
_cn_patterns = [
    # æ ‡é¢˜åœ¨å‰ï¼šå¤©å®‰é—¨ 2025 å¹´ 8 æœˆ 24 æ—¥
    re.compile(r"^(?P<title>.+?)\s*(?P<y>\d{4})\s*å¹´\s*(?P<m>\d{1,2})\s*æœˆ(?:\s*(?P<d>\d{1,2})\s*æ—¥)?$"),
    # æ—¥æœŸåœ¨å‰ï¼š2025 å¹´ 8 æœˆ 24 æ—¥ å¤©å®‰é—¨
    re.compile(r"^(?P<y>\d{4})\s*å¹´\s*(?P<m>\d{1,2})\s*æœˆ(?:\s*(?P<d>\d{1,2})\s*æ—¥)?\s*(?P<title>.+?)$"),
]

_iso_patterns = [
    # æ ‡é¢˜åœ¨å‰ï¼šå¤©å®‰é—¨ 2025-08-24 / 2025/08/24 / 2025.08.24 / 2025-08
    re.compile(r"^(?P<title>.+?)\s*(?P<y>\d{4})[-/.](?P<m>\d{1,2})(?:[-/.](?P<d>\d{1,2}))?$"),
    # æ—¥æœŸåœ¨å‰ï¼š2025-08-24 å¤©å®‰é—¨
    re.compile(r"^(?P<y>\d{4})[-/.](?P<m>\d{1,2})(?:[-/.](?P<d>\d{1,2}))?\s*(?P<title>.+?)$"),
]


def _to_date(y: str, m: str, d: Optional[str]) -> Optional[dt.date]:
    try:
        year = int(y)
        month = int(m)
        day = int(d) if d else 1  # æ— æ—¥ï¼Œé»˜è®¤ 1 å·
        return dt.date(year, month, day)
    except ValueError:
        return None


def parse_title_date(folder_name: str) -> Tuple[str, Optional[dt.date]]:
    name = folder_name.strip()
    for pat in _cn_patterns + _iso_patterns:
        m = pat.match(name)
        if m:
            gd = m.groupdict()
            title = (gd.get("title") or "").strip()
            date = _to_date(gd["y"], gd["m"], gd.get("d"))
            # è‹¥æ ‡é¢˜ç©ºï¼Œå°±æŠŠæ—¥æœŸä»åŸåä¸­æŠ¹æ‰åä½œä¸ºæ ‡é¢˜
            if not title:
                title = pat.sub("", name).strip("-_ Â·ï¼Œ, ") or name
            return title, date
    # æ²¡åŒ¹é…åˆ°æ—¥æœŸï¼Œæ•´ä¸²å½“æ ‡é¢˜
    return name, None


def allowed_image(p: Path) -> bool:
    return p.is_file() and p.suffix.lower() in ALLOWED_EXTS


# ====== æ‰«æä¸ç¼“å­˜ ======
_cache = {"at": 0.0, "data": []}


def _scan_once() -> List[Category]:
    if not IMAGES_ROOT.exists():
        return []

    categories: List[Category] = []

    for cat_dir in sorted([p for p in IMAGES_ROOT.iterdir() if p.is_dir()]):
        albums: List[Album] = []
        for album_dir in sorted([p for p in cat_dir.iterdir() if p.is_dir()]):
            imgs = sorted([f.name for f in album_dir.iterdir() if allowed_image(f)])
            if not imgs:
                continue  # ç©ºç›¸å†Œä¸å±•ç¤º
            title, date = parse_title_date(album_dir.name)
            rel_dir = str(album_dir.relative_to(IMAGES_ROOT)).replace("\\", "/")
            albums.append(Album(
                category=cat_dir.name,
                folder=album_dir.name,
                title=title,
                date=date,
                rel_dir=rel_dir,
                images=imgs,
            ))

        # ç›¸å†ŒæŒ‰æ—¥æœŸå€’åºï¼ˆæ— æ—¥æœŸé åå†æŒ‰åç§°ï¼‰
        albums.sort(key=lambda a: (a.date is not None, a.date or dt.date(1, 1, 1), a.title), reverse=True)
        if albums:
            categories.append(Category(name=cat_dir.name, rel_dir=cat_dir.name, albums=albums))

    # åˆ†ç±»æŒ‰åç§°æ’åºï¼ˆä¸­æ–‡ OKï¼‰
    categories.sort(key=lambda c: c.name)
    return categories


def get_catalog() -> List[Category]:
    now = time.time()
    if now - _cache["at"] > CACHE_TTL_SECONDS or not _cache["data"]:
        _cache["data"] = _scan_once()
        _cache["at"] = now
    return _cache["data"]


# ====== Jinja è¿‡æ»¤å™¨ ======
@app.template_filter("cn_date")
def jinja_cn_date(d: Optional[dt.date]) -> str:
    if not d:
        return "æœªæ ‡æ³¨æ—¥æœŸ"
    return f"{d.year} å¹´ {d.month} æœˆ{f' {d.day} æ—¥' if d.day else ''}"


# ====== è·¯ç”± ======
@app.route("/")
def index():
    cats = get_catalog()
    return render_template("index.html", categories=cats)


@app.route("/c/<category>/")
def view_category(category: str):
    cats = get_catalog()
    cat = next((c for c in cats if c.name == category), None)
    if not cat:
        abort(404)
    return render_template("category.html", category=cat)


@app.route("/c/<category>/<album>/")
def view_album(category: str, album: str):
    cats = get_catalog()
    cat = next((c for c in cats if c.name == category), None)
    if not cat:
        abort(404)
    alb = next((a for a in cat.albums if a.folder == album), None)
    if not alb:
        abort(404)
    return render_template("album.html", category=cat, album=alb)


@app.route("/media/<path:filename>")
def media(filename: str):
    # é™åˆ¶ä»…æœåŠ¡å›¾ç‰‡æ–‡ä»¶
    p = (IMAGES_ROOT / filename).resolve()
    try:
        p.relative_to(IMAGES_ROOT)
    except Exception:
        abort(404)
    if p.suffix.lower() not in ALLOWED_EXTS or not p.exists():
        abort(404)
    rel = str(p.relative_to(IMAGES_ROOT)).replace("\\", "/")
    return send_from_directory(IMAGES_ROOT, rel)


if __name__ == "__main__":
    app.run(debug=True)
```

---

## å››ã€templates/base.htmlï¼ˆé€šç”¨å¸ƒå±€ + é¡¶éƒ¨å¯¼èˆª + æš—è‰²æ¨¡å¼ï¼‰

```html
<!-- templates/base.html -->
<!doctype html>
<html lang="zh-CN" class="no-js">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}å›¾ç‰‡åº“{% endblock %}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    // åˆå§‹æš—è‰²æ¨¡å¼
    (function(){
      const m = localStorage.getItem('theme');
      if (m === 'dark') document.documentElement.classList.add('dark');
    })();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="{{ url_for('index') }}">ğŸ“· å›¾ç‰‡åº“</a>
      <nav class="nav">
        <a href="{{ url_for('index') }}">å…¨éƒ¨åˆ†ç±»</a>
      </nav>
      <button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">â˜¾</button>
    </div>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer container">
    <p>è‡ªåŠ¨ç”Ÿæˆäºæœ¬åœ° <code>images/</code> ç›®å½• Â· Flask</p>
  </footer>

  <script>
    const btn = document.getElementById('themeToggle');
    btn?.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const dark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
    });
  </script>
</body>
</html>
```

---

## äº”ã€templates/index.htmlï¼ˆåˆ†ç±»æ€»è§ˆé¡µï¼‰

```html
<!-- templates/index.html -->
{% extends 'base.html' %}
{% block title %}å…¨éƒ¨åˆ†ç±» - å›¾ç‰‡åº“{% endblock %}
{% block content %}
<h1 class="page-title">å…¨éƒ¨åˆ†ç±»</h1>
<div class="grid">
  {% for c in categories %}
  <a class="card" href="{{ url_for('view_category', category=c.name) }}">
    <div class="card-cover">
      {% if c.cover_relfile %}
      <img loading="lazy" src="{{ url_for('media', filename=c.cover_relfile) }}" alt="{{ c.name }} cover">
      {% else %}
      <div class="placeholder">No Cover</div>
      {% endif %}
    </div>
    <div class="card-body">
      <div class="card-title">{{ c.name }}</div>
      <div class="card-meta">
        <span class="badge">{{ c.total_albums }} ç›¸å†Œ</span>
        <span class="badge">{{ c.total_images }} å¼ </span>
      </div>
    </div>
  </a>
  {% endfor %}
</div>
{% if not categories %}
<p class="muted">è¿˜æ²¡æœ‰å¯ç”¨çš„åˆ†ç±»ï¼Œè¯·åœ¨ <code>images/</code> ä¸‹åˆ›å»º <code>åˆ†ç±»/ç›¸å†Œ/å›¾ç‰‡</code> ç»“æ„ã€‚</p>
{% endif %}
{% endblock %}
```

---

## å…­ã€templates/category.htmlï¼ˆæŸåˆ†ç±»ä¸‹çš„ç›¸å†Œåˆ—è¡¨ï¼‰

```html
<!-- templates/category.html -->
{% extends 'base.html' %}
{% block title %}{{ category.name }} - å›¾ç‰‡åº“{% endblock %}
{% block content %}
<nav class="breadcrumbs"><a href="{{ url_for('index') }}">å…¨éƒ¨åˆ†ç±»</a> <span>/</span> <span>{{ category.name }}</span></nav>
<h1 class="page-title">{{ category.name }} Â· ç›¸å†Œ</h1>

<div class="grid">
  {% for a in category.albums %}
  <a class="card" href="{{ url_for('view_album', category=category.name, album=a.folder) }}">
    <div class="card-cover">
      {% if a.cover_relfile %}
      <img loading="lazy" src="{{ url_for('media', filename=a.cover_relfile) }}" alt="{{ a.title }} cover">
      {% else %}
      <div class="placeholder">No Cover</div>
      {% endif %}
      <div class="ribbon">{{ a.date|cn_date }}</div>
    </div>
    <div class="card-body">
      <div class="card-title">{{ a.title }}</div>
      <div class="card-meta">
        <span class="badge">{{ a.images|length }} å¼ </span>
      </div>
    </div>
  </a>
  {% endfor %}
</div>
{% if not category.albums %}
<p class="muted">è¯¥åˆ†ç±»æš‚æ— ç›¸å†Œã€‚</p>
{% endif %}
{% endblock %}
```

---

## ä¸ƒã€templates/album.htmlï¼ˆç›¸å†Œè¯¦æƒ…é¡µï¼šæ ‡é¢˜ + æ—¥æœŸ + å›¾ç‰‡ç½‘æ ¼ï¼‰

```html
<!-- templates/album.html -->
{% extends 'base.html' %}
{% block title %}{{ album.title }} - {{ category.name }} - å›¾ç‰‡åº“{% endblock %}
{% block content %}
<nav class="breadcrumbs">
  <a href="{{ url_for('index') }}">å…¨éƒ¨åˆ†ç±»</a>
  <span>/</span>
  <a href="{{ url_for('view_category', category=category.name) }}">{{ category.name }}</a>
  <span>/</span>
  <span>{{ album.title }}</span>
</nav>

<header class="album-head">
  <h1 class="album-title">{{ album.title }}</h1>
  <div class="album-sub">{{ album.date|cn_date }} Â· {{ album.images|length }} å¼ </div>
</header>

<div class="grid images">
  {% for img in album.images %}
  <a class="img-card" href="{{ url_for('media', filename=album.rel_dir ~ '/' ~ img) }}" target="_blank" rel="noopener">
    <img loading="lazy" src="{{ url_for('media', filename=album.rel_dir ~ '/' ~ img) }}" alt="{{ album.title }} - {{ loop.index }}">
  </a>
  {% endfor %}
</div>
{% endblock %}
```

---

## å…«ã€static/style.cssï¼ˆç°ä»£ã€ç®€æ´ã€ç¾è§‚ï¼‰

```css
/* static/style.css */
:root{
  --bg:#0b0c0f;
  --bg-soft:#11131a;
  --text:#e6e9ef;
  --muted:#a0a7b4;
  --card:#141824;
  --accent:#7aa2f7;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius:22px;
}

html{background:#f7f8fb;color:#121418;-webkit-font-smoothing:antialiased;}
html.dark{background:var(--bg);color:var(--text);}

body{margin:0;font:16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Noto Sans CJK SC", "Microsoft Yahei", sans-serif;}

.container{max-width:1100px;margin:0 auto;padding:24px;}

.site-header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.7);backdrop-filter: blur(10px);border-bottom:1px solid #eef1f4;}
html.dark .site-header{background:rgba(17,19,26,.55);border-color:#1d2330;}
.header-inner{display:flex;align-items:center;gap:16px;}
.brand{font-weight:800;font-size:20px;text-decoration:none;color:inherit}
.nav a{color:inherit;text-decoration:none;opacity:.9;margin-right:12px}
.theme-toggle{border:0;background:transparent;font-size:18px;cursor:pointer}

.site-footer{opacity:.7;border-top:1px dashed #e6e8ee;margin-top:24px;padding-top:16px}
html.dark .site-footer{border-top-color:#1d2330}

.page-title{font-size:28px;font-weight:800;margin:8px 0 16px}
.muted{opacity:.65}

.breadcrumbs{opacity:.7;margin:8px 0 12px}
.breadcrumbs a{color:inherit}

.grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));gap:16px}
.grid.images{grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));}

.card{display:block;border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow: 0 6px 20px rgba(0,0,0,.06);transition: transform .2s ease, box-shadow .2s ease}
html.dark .card{background:var(--card);box-shadow: var(--shadow)}
.card:hover{transform: translateY(-2px);box-shadow: 0 10px 24px rgba(0,0,0,.12)}
html.dark .card:hover{box-shadow: 0 14px 40px rgba(0,0,0,.45)}

.card-cover{position:relative;aspect-ratio: 16/10;background:#f0f2f7;}
html.dark .card-cover{background:var(--bg-soft)}
.card-cover img{width:100%;height:100%;object-fit:cover;display:block}
.placeholder{width:100%;height:100%;display:grid;place-items:center;color:#bbb}

.ribbon{position:absolute;left:12px;bottom:12px;padding:4px 10px;border-radius:999px;background:rgba(0,0,0,.65);color:#fff;font-size:12px}

.card-body{padding:12px 14px}
.card-title{font-weight:700;font-size:16px;letter-spacing:.2px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.card-meta{margin-top:8px;display:flex;gap:8px;align-items:center}
.badge{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef1f6}
html.dark .badge{background:#1d2330}

.album-head{margin:4px 0 16px}
.album-title{margin:0;font-size:24px;font-weight:800}
.album-sub{opacity:.7;margin-top:4px}

.img-card{border-radius:16px;overflow:hidden;background:#fff;display:block}
html.dark .img-card{background:var(--card)}
.img-card img{width:100%;height:240px;object-fit:cover;display:block}

@media (max-width: 640px){
  .container{padding:14px}
  .img-card img{height:200px}
}
```

---

## ä¹ã€å‘½åå»ºè®®

* åˆ†ç±»ï¼š`images/åŒ—äº¬/ ...`ã€`images/å¦é—¨/ ...`ï¼ˆä¸­æ–‡ OKï¼‰
* ç›¸å†Œï¼š**æ¨è** `æ ‡é¢˜ YYYY å¹´ M æœˆ D æ—¥` æˆ– `YYYY-YY-DD æ ‡é¢˜`ï¼Œæ— æ—¥ä¹Ÿå¯ï¼ˆé»˜è®¤ 1 å·ï¼‰ã€‚

> ä¾‹ï¼š`å¤©å®‰é—¨ 2025 å¹´ 8 æœˆ 24 æ—¥`ã€`2025-08-24 å¤©å®‰é—¨`ã€`å—é—¨æ¶®è‚‰2025 å¹´ 8 æœˆ 25 æ—¥`

---

## åã€å¯æ‹“å±•ç‚¹ï¼ˆå·²é¢„ç•™ç»“æ„ï¼‰

* ç”Ÿæˆç¼©ç•¥å›¾æé€Ÿï¼ˆPillow/Thumbor/Nginx ç¼“å­˜ï¼‰ã€‚
* ç«™å†…æœç´¢ä¸ç›¸å†Œç­›é€‰ï¼ˆæŒ‰å¹´æœˆ/å…³é”®å­—ï¼‰ã€‚
* è½»é‡ç¯ç®±ï¼ˆåŸç”Ÿ JS/CSSï¼‰æˆ–æ‡’åŠ è½½å ä½éª¨æ¶ã€‚
* éƒ¨ç½²åˆ°å†…ç½‘/æœåŠ¡å™¨ï¼ˆGunicorn + Nginxï¼‰ã€‚
